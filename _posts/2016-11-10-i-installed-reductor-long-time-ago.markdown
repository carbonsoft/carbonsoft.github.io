---
layout: post
title:  "Я установил Carbon Reductor давным давно, что мне надо сделать чтобы всё было хорошо?"
date:   2016-11-10 14:28:06 +0500
---

Мир вокруг меняется, бизнес-правила тоже. Законопроект <http://asozd2.duma.gov.ru/main.nsf/(Spravka)?OpenAgent&RN=1102471-6> на 10 ноября 2016 ещё находится на рассмотрении, но скоро будет принят. Теперь Carbon Reductor должен работать идеально, иначе каждый пропущенный пакет от ревизора может обернуться штрафом. Всё, что мы можем делать со своей стороны - мы делаем, но многие вещи может сделать только сетевой/системный администратор провайдера.

# Настроить satellite

Ревизор, конечно всё проверяет, но когда проверка чревата штрафом - спокойно отладить блокировку становится невозможно. Мы сделали аналог ревизора, проверяющий HTTP, HTTPS и DNS фильтрацию и не "стучащий" никуда, кроме почты администратора: <https://github.com/carbonsoft/reductor_satellite_installer>

# Настроить свою страницу-заглушку

На отдельном сервере с IP адресом, доступным абонентам. Это нужно для корректной работы DNS-спуфинга для блокировки по домену. Есть готовое решение: <https://github.com/carbonsoft/reductor_blockpages>

Можно настроить это на самом Carbon Reductor, но по причине в конце статьи - лучше на отдельном веб-сервере.

# Настроить DNS-фильтрацию

В реестре появилось много ресурсов, которые требуется блокировать по домену. А это означает не только по HTTP/HTTPS, а любое обращение к этому домену. В Carbon Reductor появился модуль DNS-спуфинга, вам нужно его:

1. Включить
2. Указать IP адрес настроенной выше страницы-заглушки.

# Интеграция с DNS-серверами

Когда DNS-запросы от Ревизора попадают в DNS-сервера провайдера, они:

1. Не факт, что попадут в зеркало трафика Carbon Reductor
2. А если и попадут, то не факт, что DNS-сервер примет их из-за DNSSec-валидации

Поэтому хорошим решением будет подружить DNS-сервера с Carbon Reductor, научив его отвечать на блокируемые домены IP адресом страницы-заглушки с помощью простого набора скриптов:

## unbound

<https://github.com/carbonsoft/named_fakezone_generator/tree/master/unbound>

## bind/named

<https://github.com/carbonsoft/named_fakezone_generator>

## другие

Либо брать <https://github.com/carbonsoft/named_fakezone_generator> и дорабатывать под свой dns-сервер по аналогии, либо отключать DNSSec-валидацию.

# Интеграция с маршрутизатором

Некоторые ресурсы необходимо блокировать полностью по IP вообще по всем протоколам. Находясь в зеркале такого сделать невозможно (хотя мы и присылаем соответствующие tcp/icmp ответы на такие обращения), поэтому блокировать их лучше на маршрутизаторе. Каким образом - на ваше усмотрение:

1. Использование BGP/OSPF Remote Triggered Blackhole: <https://github.com/carbonsoft/reductor_bgp_rtbh>
2. Настроить отправку команд на оборудование для добавления/удаления/получения списка заблокированных IP в хуке events.sh.

# Скорее всего почистить собственные белые списки

Быть добрым к клиентам и разрешать доступ к популярным заблокированным ресурсам типа рутрэкера или порнхаба было клёво, но теперь это может обойтись довольно дорого.

# Настроить дополнительные параметры мониторинга

Есть готовые плагины для collectd, на их основе можно соорудить аналоги для используемых вами систем мониторинга. <https://github.com/carbonsoft/collectd-reductor>

# Добиться идеального latency

В случае с анализом зеркала трафика важно, чтобы срабатывание происходило гарантированно быстро. Подробнее почитать про это можно по ссылке: <https://strizhechenko.github.io/2016/11/09/reductor-and-vm.html>

Кратко:

- Купить хорошие сетевые карты и обязательно настроить их.
- Отказаться от виртуальных машин и перейти на железо.
- Избавиться даже от единичных потерь на стороне зеркалирующего оборудования.
- Озаботиться тем, чтобы Carbon Reductor не занимался ничем кроме фильтрации, в том числе и веб-сервера.
- Отправить [критически важных абонентов](https://portal.rfc-revizor.ru/) в [разрыв через Carbon Reductor](http://docs.carbonsoft.ru/pages/viewpage.action?pageId=67108964) чтобы не беспокоиться о потерях на свитче.
- Заиметь резервный сервер Carbon Reductor (бесплатно) и настроить схему с их взаимодействием (скоро появится)
